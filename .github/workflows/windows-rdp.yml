name: Windows RDP with Python & Mumu Emulator

on:
  workflow_dispatch:
    inputs:
      tailscale_auth_key:
        description: 'Tailscale Auth Key (required)'
        required: true
      rdp_password:
        description: 'RDP Password (default: Manik2200@@)'
        required: false
        default: 'Manik2200@@'

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Tailscale
        run: |
          # Install Tailscale
          $tailscaleInstaller = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $tailscaleInstaller
          Start-Process msiexec.exe -Wait -ArgumentList "/i", "`"$tailscaleInstaller`"", "/quiet", "/norestart"
          
          # Connect to Tailscale
          & "C:\Program Files\Tailscale\tailscale.exe" logout 2>$null
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey "${{ github.event.inputs.tailscale_auth_key }}" --hostname "github-windows-${{ github.run_id }}"
          
          # Get Tailscale IP
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "✅ Tailscale IP: $ip"

      - name: Create RDP User
        run: |
          $username = "mtqmanik"
          $password = "${{ github.event.inputs.rdp_password }}"
          
          # Create user
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $username -Password $securePassword -AccountNeverExpires
          
          # Add to groups
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          
          # Enable RDP
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          Write-Host "✅ RDP User created: $username"

      - name: Install Python and Required Modules
        run: |
          # Install Python 3.10
          choco install python --version=3.10.0 -y
          refreshenv
          
          # Upgrade pip
          python -m pip install --upgrade pip
          
          # Install required Python modules
          python -m pip install opencv-python
          python -m pip install uiautomator2
          python -m pip install playwright
          python -m pip install customtkinter
          python -m pip install pillow numpy pandas
          
          # Install Playwright browsers
          playwright install chromium
          
          Write-Host "✅ Python modules installed"

      - name: Install Visual Studio Code
        run: |
          choco install vscode -y
          
          # Install VS Code extensions
          & "C:\Program Files\Microsoft VS Code\bin\code.cmd" --install-extension ms-python.python
          & "C:\Program Files\Microsoft VS Code\bin\code.cmd" --install-extension ms-python.vscode-pylance
          
          Write-Host "✅ VS Code installed"

      - name: Install Mumu Player 12
        run: |
          # Download Mumu Player
          $mumuUrl = "https://mumu.163.com/download/win/MuMuPlayer-12.0.5.2-240726131525-win-64bit.exe"
          $mumuPath = "$env:TEMP\MuMuPlayer.exe"
          
          Invoke-WebRequest -Uri $mumuUrl -OutFile $mumuPath
          
          # Install silently
          Start-Process -FilePath $mumuPath -ArgumentList "/S" -Wait
          Start-Sleep -Seconds 30
          
          Write-Host "✅ Mumu Player installed"

      - name: Install Additional Tools
        run: |
          # Install Chocolatey if not installed
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }
          
          # Install tools
          choco install git -y
          choco install adb -y
          choco install nodejs -y
          
          Write-Host "✅ Additional tools installed"

      - name: Configure System
        run: |
          # Disable sleep
          powercfg -change -standby-timeout-ac 0
          
          # Disable Windows Defender temporarily
          Set-MpPreference -DisableRealtimeMonitoring $true
          
          Write-Host "✅ System configured"

      - name: Create Desktop Files
        run: |
          # Create connection info file
          $infoContent = @"
